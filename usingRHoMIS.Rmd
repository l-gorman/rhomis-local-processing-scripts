---
title: "Using RHoMIS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is some short documentation on how use the RHoMIS R-package
to process data locally. Data processing occurs in three main steps:

1. Extract all new values (e.g. crop names, crop units ...).
2. Examining these units and providing the necessary conversion factors
3. Processing the data and calculating indicators

## Setup

Firstly, you will want to make sure that you have the most recent
version of the RHoMIS R-package installed, along with the devtools 
library:

```{r eval=FALSE, echo=T}
install.packages("devtools")
devtools::install_github("https://github.com/l-gorman/rhomis-R-package", force = TRUE)
```

You should then ensure you have a folder containing the data
you would like to process. If using Rstudio interactively, set
your working directory to this folder using the `setwd()` command.
Your directory structure should look something like this:

```
ðŸ“‚ project
   â”—ðŸ“‚ raw-data
     â”—ðŸ“œ rhomis_data.csv
```

In this case, your working directory should be the `project` folder.

## Dealing with Units

### Extracting Units

To extract new units from the data you are working with, run the
code below. This code can also be found in the `extractValues.R` file, included 
alongside this Rmarkdown document.

```{r eval=FALSE, echo=T}
library(rhomis)

survey_file_path <- "./raw-data/rhomis_data.csv"

processData(
   dataSource = "csv",
   outputType = "csv",
   extractUnits = T,
   processDataSet = F,
   dataFilePath = survey_file_path
)
```

If you now go back to your `project` directory, you should be able
to see that more files have been added:

```
ðŸ“‚ project
   â”£ðŸ“œ rhomis_data.csv
   â”£ðŸ“‚ unit_conversions
   â”ƒ â”£ðŸ“œ crop_yield_units.csv
   â”ƒ â”£ðŸ“œ country.csv
   â”ƒ â”—ðŸ“œ ...
   â”—ðŸ“‚ log 
     â”—ðŸ“œ warnings.log
```

### Converting Units

__Please note, while you do not _have_ to convert units for the next step in
the calculations to run, uncoverted units will be ignored and will lead to 
unnecessary missing values__

In the `project/unit_conversions` directory, you will find a series of csv files 
with conversion factors that need to be filled in. Each file will look 
like the table below. The first column indicates a value which was 
found in the survey. The second column shows the conversion factor 
which ought to be used. Where the conversion factor is unknown, the column
will display `NA`. Where the conversion factor is known it will be provided.
Known conversion factors are already embedded in the R-package.

```{r echo=F, eval=T}
knitr::kable(data.frame(list(
   survey_value = c("foo", "bar"),
   conversion = c(NA, NA)
)))
```

There are a range of conversions to enter and it is important to be aware
which units are needed. Each file is described in more detail below:


| File | Description | Example Survey Value | Example Conversion |
| :--- | :------- | :------- | :------- |
| bees_honey_production_units.csv  | The conversion factor should be used to convert to kilograms/litres. | buckets_12_litre | 12 |
| country.csv | The conversion factor should be used to convert country names to [two-letter ISO country codes](https://www.iban.com/country-codes).  | uganda | UG |
| crop_name.csv | The name of crops entered in the survey. Often enumerators may specify "other" crops in a free-text-entry field. Sometimes these crops can be mispelt, or in a language other than English. Here we correct mispellings and translations into standard forms (__all lower case__)  |  maze | maize  |
| crop_sold_price_quantityunits.csv  |  The price units for crops which were sold. Please note that only one unit will be converted into a string, "total_income_per_year" will be converted to "total_income_per_year" as this is treated as a special case in the analysis scripts. | price_per_50kg_sack | 0.02 |
| crop_yield_units.csv  |  The unit of crops which have been collected. This needs to be converted to kilograms | cart_250kg  | 250 |
| eggs_sold_price_timeunits.csv  | The amount of money made per unit time for selling eggs. This needs to be converted into an income per year  | income for 3 months | 4 |
| eggs_units.csv  | The number of eggs collected per year | pieces/day | 365 |
| fertiliser_units.csv |  The amount of fertiliser in kg |  sacks_25kg | 25  |
| livestock_name.csv  | The names of livestock entered in the survey. As with crop names, enumerators can also enter extra livestock names which are in a different language or mispelt. This conversion is used to standardise livestock names entered in the survey | catel | cattle |
| milk_sold_price_timeunits.csv  |  The amount of money made per unit volume or per unit time. For unit time, the options are "day", "week", "month", "year". These time units must be entered as strings. For the unit volume, numeric conversions must be entered| month | month |
|      |       |  0.3litre | 0.3  |
| milk_units.csv  | The amount of milk  collected in litres per year. There are a number of exceptions which must be kept as text strings, and are dealt with in the analysis scripts (e.g. "per animal per day" and "l/animal/day" |  l/day  | 365 |
| unitland.csv  | The amount of land in hectares |  acres  | 0.4  |

### The Log file

You may have noticed that there was a `log` folder located in the directory 
structure, containing a file `warnings.log`. This file contains any warnings
which were thrown as a result of running the `processData()` function. These
warnings become particularly useful in the next section, where you will process 
a data-set and calculate indicators. This log file will tell you which columns
were missing from the data-set and how this affected your ability to calculate
particular indicators.

## Processing the Data

As with unit extraction, ensure you are in the project directory.
Then enter the commands below (please note these are identical to the `processData.R` file):

```{r eval=FALSE, echo=T}
library(rhomis)

survey_file_path <- ".raw-data/rhomis_data.csv"

processData(
   dataSource = "csv",
   outputType = "csv",
   extractUnits = F,
   processDataSet = T,
   dataFilePath = survey_file_path
)
```
__Be careful that `extractUnits` is set to `FALSE`, otherwise the units 
which were converted in the previous section will be overwritten.__

You will now see that the directory structure again looks quite different:

```
ðŸ“‚ project
   â”£ðŸ“œ rhomis_data.csv
   â”£ðŸ“‚ unit_conversions
   â”ƒ â”£ðŸ“œ bees_honey_production_units.csv
   â”ƒ â”£ðŸ“œ crop_name.csv
   â”ƒ â”—ðŸ“œ ...
   â”£ðŸ“‚ log 
   â”ƒ â”—ðŸ“œ warnings.log
   â”£ðŸ“‚ crop_data
   â”ƒ â”£ðŸ“œ crop_consumed_kg_per_year.csv
   â”ƒ â”£ðŸ“œ crop_harvest_kg_per_year.csv
   â”ƒ â”—ðŸ“œ ...
   â”£ðŸ“‚ indicators
   â”ƒ â”—ðŸ“œ indicators.csv
   â”£ðŸ“‚ livestock_data
   â”ƒ â”£ðŸ“œ crop_consumed_kg_per_year.csv
   â”ƒ â”£ðŸ“œ crop_consumed_kg_per_year.csv
   â”ƒ â”—ðŸ“œ ...
   â”£ðŸ“‚ mean_prices
   â”ƒ â”£ðŸ“œ crop_prices.csv
   â”ƒ â”£ðŸ“œ livestock_price_per_animal.csv
   â”ƒ â”—ðŸ“œ ...
   â”£ðŸ“‚ off_farm_data
   â”ƒ â”£ðŸ“œ offfarm_income_name.csv
   â”ƒ â”£ðŸ“œ offfarm_who_control_revenue.csv
   â”ƒ â”—ðŸ“œ ...
   â”—ðŸ“‚ processed_data
     â”—ðŸ“œ processed_data.csv
   
   
```

## Outputs

### Indicators

Indicators calculated whilst the data was being processed. These cover a range of
topics, including incomes, dietary diversity, and household demographics. The indicators
calculated depend on the columns present in the original `raw-data.csv` file.

### Crop Data

Found in the `crop_data` directory, in each of the csvs, a column represents the crops
listed in the survey, each row represents one household (in the same row order as the original dataset)

### Livestock Data

Found in the `livestock_data` directory, in each of the csvs, a column represents the types of livestock listed in the survey,
again each row represents a household.

### Off-farm Data

Found in the `off_farm_data` directory, in each of the csvs, a column represents an off-farm activity, and each row represents 
a household.

## Extensions

The format of this dataset, and the new developments in the R-package should make 
it easier to calculate a range of indicators which were previously quite difficult
to calculate yourself.

However, it can be difficult to anticipate all of the calculations our users would 
like to make. If there is anything you would like to calculate, we would be happy to
try and help. Please raise any extensions/queries in the issues section, and we will
do our best to assist.

## Examples

Looking through the data you may notice that it looks slightly different to 
previous versions of RHoMIS which you have seen. The data is now arranged in
which should make usual calculations slightly easier. To see an example of 
how to calculate the value of each product consumed, please refer to the 
`valueCalculations.R` script.

